<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Step-Back Prompt (SSE Manual)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
  <link href="/css/springai.css" rel="stylesheet" />
  <script src="/js/springai.js"></script>

  <style>
    /* 줄바꿈이 화면에 그대로 보이도록 설정 */
    .answer-content {
        white-space: pre-wrap; 
        line-height: 1.6;
    }
  </style>

  <script>
    async function handleSubmit() {
      // 1. 입력값 가져오기
      const questionInput = document.getElementById("question");
      const question = questionInput.value;
      if (question === "") return;

      // 2. UI 설정 (질문 말풍선 추가)
      // (springai.js의 단순 UI 생성 기능은 재사용. 원하시면 이것도 풀어서 써드릴 수 있습니다)
      springai.addUserQuestion(question, "chatPanel");
      springai.setSpinner("spinner", true);

      // 3. 답변 들어갈 말풍선 미리 만들기
      const uuid = springai.addAnswerPlaceHolder("chatPanel");
      const answerElement = document.getElementById(uuid);
      answerElement.className = "answer-content"; // CSS 적용

      try {
        // 4. Fetch 요청 (SSE 모드)
        const response = await fetch('/ai/prompt/step-back-prompt', {
          method: "post",
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'text/event-stream' // 핵심: SSE 요청
          },          
          body: new URLSearchParams({ question })
        });

        // 5. 스트림 리더 생성
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        // 6. 스트림 읽기 루프 (직접 구현)
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          // 바이너리 -> 텍스트 디코딩
          const chunk = decoder.decode(value, { stream: true });

          // SSE 데이터 파싱 ("data: " 접두어 제거)
          // 한 번에 여러 줄이 올 수 있으므로 줄바꿈(\n)으로 분리
          const lines = chunk.split('\n');

          for (const line of lines) {
            // 빈 줄 무시
            if (!line.trim()) continue;

            // "data:" 로 시작하는 표준 SSE 메시지만 처리
            if (line.startsWith('data:')) {
              // "data:" 제거 및 앞뒤 공백 제거
              const textData = line.replace(/^data:/, ''); // 앞의 공백은 유지하고 싶으면 trim() 제외
              
              // 실제 데이터가 있을 경우 화면에 추가
              // 줄바꿈이 포함된 텍스트가 올 수 있으니 그대로 append
              answerElement.innerText += textData + "\n"; 
              
              // 스크롤 자동 이동
              const chatPanel = document.getElementById("chatPanel");
              chatPanel.scrollTop = chatPanel.scrollHeight;
            }
          }
        }

      } catch (error) {
        console.error("Stream Error:", error);
        answerElement.innerText += "\n[에러 발생: " + error.message + "]";
      } finally {
        springai.setSpinner("spinner", false);
      }
    } 
  </script>
</head>

<body>
  <div class="d-flex flex-column vh-100">
    <div id="headPanel" class="navbar justify-content-between">
      <a href="/" class="navbar-brand ps-2">
        <img src="/image/spring_ai_logo_with_text.svg" width="200" />
      </a>
      <div id="spinner" class="spinner-border text-success d-none me-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div id="chatPanel" class="flex-grow-1 container-fluid h-100 my-2" style="overflow-y:auto; overflow-x:hidden;">
      <div class="d-flex justify-content-start border-bottom m-2">
        <table>
          <tr>
            <td><img src="/image/assistant.png" width="50" /></td>
            <td><span>질문을 올려주세요.</span></td>
          </tr>
        </table>
      </div>
    </div>

    <div id="inputPanel" class="bg-secondary-subtle">
      <div class="input-group p-2">
        <span class="input-group-text">질문</span>
        <textarea id="question" class="form-control">서울에서 울릉도로 갈 때 비용이 가장 적게 드는 방법은?</textarea>
        <span class="input-group-text">
          <button type="button" class="btn btn-primary" onclick="handleSubmit()">제출</button>
        </span>
      </div>
    </div>
  </div>
</body>
</html>